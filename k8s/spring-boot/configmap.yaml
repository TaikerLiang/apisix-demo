apiVersion: v1
kind: ConfigMap
metadata:
  name: spring-boot-config
  namespace: apisix-demo
  labels:
    app: spring-boot
data:
  application.yaml: |
    spring:
      application:
        name: hello
      mvc:
        log-request-details: true

    server:
      tomcat:
        accesslog:
          enabled: false

    management:
      endpoints:
        web:
          exposure:
            include: health,info,metrics,prometheus
          base-path: /actuator
      endpoint:
        health:
          probes:
            enabled: true
          show-details: when-authorized
      health:
        livenessState:
          enabled: true
        readinessState:
          enabled: true

  logback-spring.xml: |
    <?xml version="1.0" encoding="UTF-8"?>
    <configuration>
        <include resource="org/springframework/boot/logging/logback/defaults.xml"/>

        <!-- Console appender with JSON format -->
        <appender name="CONSOLE_JSON" class="ch.qos.logback.core.ConsoleAppender">
            <encoder class="net.logstash.logback.encoder.LogstashEncoder">
                <customFields>{"service":"hello"}</customFields>
                <fieldNames>
                    <timestamp>timestamp</timestamp>
                    <message>message</message>
                    <logger>logger</logger>
                    <thread>thread</thread>
                    <level>level</level>
                    <levelValue>[ignore]</levelValue>
                </fieldNames>
            </encoder>
        </appender>

        <!-- Access log appender with structured JSON -->
        <appender name="ACCESS_JSON" class="ch.qos.logback.core.ConsoleAppender">
            <encoder class="net.logstash.logback.encoder.LogstashEncoder">
                <customFields>{"service":"hello","log_type":"access"}</customFields>
            </encoder>
        </appender>

        <!-- Logger for access logs -->
        <logger name="org.apache.catalina.valves.AccessLogValve" level="INFO" additivity="false">
            <appender-ref ref="ACCESS_JSON"/>
        </logger>

        <!-- Logger for Spring Web requests -->
        <logger name="org.springframework.web.servlet.DispatcherServlet" level="DEBUG" additivity="false">
            <appender-ref ref="CONSOLE_JSON"/>
        </logger>

        <!-- Root logger -->
        <root level="INFO">
            <appender-ref ref="CONSOLE_JSON"/>
        </root>
    </configuration>
