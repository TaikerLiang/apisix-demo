apiVersion: v1
kind: ConfigMap
metadata:
  name: filebeat-config
  namespace: elk-stack
  labels:
    app: filebeat
data:
  filebeat.yml: |-
    filebeat.inputs:
      # Collect container logs from all namespaces
      - type: container
        paths:
          - /var/log/containers/*.log
        processors:
          # Add Kubernetes metadata
          - add_kubernetes_metadata:
              host: ${NODE_NAME}
              matchers:
                - logs_path:
                    logs_path: "/var/log/containers/"
          # Drop system/kube-system logs (optional, can be removed)
          - drop_event:
              when:
                or:
                  - equals:
                      kubernetes.namespace: "kube-system"
                  - equals:
                      kubernetes.namespace: "kube-public"
                  - equals:
                      kubernetes.namespace: "kube-node-lease"
          # Parse JSON logs
          - decode_json_fields:
              fields: ["message"]
              target: ""
              overwrite_keys: true

    # Output to Elasticsearch
    output.elasticsearch:
      hosts: ["elasticsearch:9200"]
      index: "filebeat-%{[agent.version]}-%{+yyyy.MM.dd}"

    # Index lifecycle settings
    setup.ilm.enabled: false
    setup.template.name: "filebeat"
    setup.template.pattern: "filebeat-*"
    setup.template.settings:
      index.number_of_shards: 1
      index.number_of_replicas: 0

    # Kibana dashboard setup
    setup.kibana:
      host: "kibana:5601"

    # Logging
    logging.level: info
    logging.to_files: false
